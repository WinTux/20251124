name: CI Microservicios

on:
  push:
  pull_request:

permissions:
  contents: read
  security-events: write
  id-token: write
  packages: write

jobs:
  build-test-run:
    runs-on: ubuntu-latest

    services:
      producto-db:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ secrets.DB_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: productodb
        ports:
          - 5433:5432

      orden-db:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ secrets.DB_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ordendb
        ports:
          - 5434:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Install Snyk CLI
        run: npm install -g snyk
      - name: Snyk Dependency Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test --all-projects --severity-threshold=medium

      - name: Trivy Filesystem Scan (SAST + config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'
      # Compila SOLO los módulos microservicios (no proyecto root)
      - name: Compilar modulos sin tests
        run: mvn -B -pl producto-service,orden-service -am clean package -DskipTests
      # =====================================================
      # Hardening: OPA/Conftest sobre Dockerfiles
      # =====================================================
      - name: Instalando Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.65.0/conftest_0.65.0_Linux_x86_64.tar.gz \
          | tar zx
          sudo mv conftest /usr/local/bin/
          conftest --version
      - name: Validate policies
        run: |
          conftest verify --policy policy

      - name: Debug Dockerfile parser output
        run: |
          echo "=== producto-service parsed ==="
          conftest parse --parser dockerfile producto-service/Dockerfile

          echo "=== orden-service parsed ==="
          conftest parse --parser dockerfile orden-service/Dockerfile
      - name: Security Policy Check (Dockerfile)
        run: |
          conftest test --parser dockerfile producto-service/Dockerfile --output json || true
          conftest test --parser dockerfile orden-service/Dockerfile --output json || true
      # =====================================================
      # SBOM (Software Bill of Materials)
      # =====================================================
      - name: SBOM producto-service (CycloneDX)
        uses: anchore/sbom-action@v0
        with:
          path: producto-service
          format: cyclonedx-json
          output-file: producto-sbom.json
          upload-artifact: true

      - name: Snyk SBOM Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk sbom test --experimental --file=producto-sbom.json -d


      - name: SBOM orden-service
        uses: anchore/sbom-action@v0
        with:
          path: orden-service
          format: cyclonedx-json
          output-file: orden-sbom.json
          upload-artifact: true
      - name: Snyk SBOM Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk sbom test --experimental --file=orden-sbom.json -d

      # ───────────────────────────────
      # Levantar PRODUCTO-SERVICE
      # ───────────────────────────────
      - name: Iniciar producto-service
        env:
          SPRING_DATASOURCE_USERNAME: ${{ secrets.DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          cd producto-service
          nohup java -jar target/*.jar \
            --server.port=8081 \
            --spring.datasource.url=jdbc:postgresql://localhost:5433/productodb \
            > ../logs/producto-service.log 2>&1 &

      # ───────────────────────────────
      # Levantar ORDEN-SERVICE (dependiente)
      # ───────────────────────────────
      - name: Iniciar orden-service
        env:
          SPRING_DATASOURCE_USERNAME: ${{ secrets.DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          cd orden-service
          nohup java -jar target/*.jar \
            --server.port=8082 \
            --spring.datasource.url=jdbc:postgresql://localhost:5434/ordendb \
            --external.product-service.url=http://localhost:8081 \
            > ../logs/orden-service.log 2>&1 &

      - name: Esperar hasta que los servicios estén listos
        run: sleep 25

      - name: Ejecutar integration tests (multi-module)
        env:
          PRODUCT_SERVICE_URL: http://localhost:8081
          ORDERS_SERVICE_URL: http://localhost:8082
        run: mvn -B test -pl producto-service,orden-service
