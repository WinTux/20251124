name: CI Microservicios

on:
  push:
  pull_request:

permissions:
  contents: read
  security-events: write
  id-token: write
  packages: write

jobs:
  build-test-run:
    runs-on: ubuntu-latest

    services:
      producto-db:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ secrets.DB_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: productodb
        ports:
          - 5433:5432

      orden-db:
        image: postgres:15
        env:
          POSTGRES_USER: ${{ secrets.DB_USERNAME }}
          POSTGRES_PASSWORD: ${{ secrets.DB_PASSWORD }}
          POSTGRES_DB: ordendb
        ports:
          - 5434:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
      - name: Install Snyk CLI
        run: npm install -g snyk
      - name: Snyk Dependency Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk test --all-projects --severity-threshold=medium

      - name: Trivy Filesystem Scan (SAST + config)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          ignore-unfixed: true
          severity: 'HIGH,CRITICAL'
      # Compila SOLO los módulos microservicios (no proyecto root)
      - name: Compilar modulos sin tests
        run: mvn -B -pl producto-service,orden-service -am clean package -DskipTests
      # =====================================================
      # Hardening: OPA/Conftest sobre Dockerfiles
      # =====================================================
      - name: Instalando Conftest
        run: |
          curl -L https://github.com/open-policy-agent/conftest/releases/download/v0.65.0/conftest_0.65.0_Linux_x86_64.tar.gz \
          | tar zx
          sudo mv conftest /usr/local/bin/
          conftest --version
      - name: Validate policies
        run: |
          conftest verify --policy policy

      - name: Debug Dockerfile parser output
        run: |
          echo "=== producto-service parsed ==="
          conftest parse --parser dockerfile producto-service/Dockerfile

          echo "=== orden-service parsed ==="
          conftest parse --parser dockerfile orden-service/Dockerfile
      - name: Security Policy Check (Dockerfile)
        run: |
          conftest test --parser dockerfile producto-service/Dockerfile --output json || true
          conftest test --parser dockerfile orden-service/Dockerfile --output json || true
      # =====================================================
      # SBOM (Software Bill of Materials)
      # =====================================================
      - name: SBOM producto-service (CycloneDX)
        uses: anchore/sbom-action@v0
        with:
          path: producto-service
          format: cyclonedx-json
          output-file: producto-sbom.json
          upload-artifact: true

      - name: Snyk SBOM Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk sbom test --experimental --file=producto-sbom.json -d || true


      - name: SBOM orden-service
        uses: anchore/sbom-action@v0
        with:
          path: orden-service
          format: cyclonedx-json
          output-file: orden-sbom.json
          upload-artifact: true
      - name: Snyk SBOM Scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: snyk sbom test --experimental --file=orden-sbom.json -d || true
      # ───────────────────────────────
      # Integrando SBOM con Trivy y reportarlo como SARIF para GitHub Security Dashboard
      # ───────────────────────────────
      - name: Generate SBOM with Trivy (CycloneDX)
        run: trivy fs . --format cyclonedx --output producto-sbom-1.json

      - name: Trivy SBOM -> SARIF
        run: trivy sbom producto-sbom-1.json --format sarif --output trivy-sbom-1.sarif

      - name: Subiendolo con SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-sbom-1.sarif
          category: producto-service

      - name: Generate SBOM with Trivy (CycloneDX)
        run: trivy fs . --format cyclonedx --output orden-sbom-1.json

      - name: Trivy SBOM -> SARIF
        run: trivy sbom orden-sbom-1.json --format sarif --output trivy-sbom-2.sarif

      - name: Subiendolo con SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-sbom-2.sarif
          category: orden-service
      - name: Upload SARIF artifact
        uses: actions/upload-artifact@v4
        with:
          name: sarif-files
          path: "*.sarif"

      # ───────────────────────────────
      # Levantar PRODUCTO-SERVICE
      # ───────────────────────────────
      - name: Iniciar producto-service
        env:
          SPRING_DATASOURCE_USERNAME: ${{ secrets.DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          cd producto-service
          nohup java -jar target/*.jar \
            --server.port=8081 \
            --spring.datasource.url=jdbc:postgresql://localhost:5433/productodb \
            > ../logs/producto-service.log 2>&1 &

      # ───────────────────────────────
      # Levantar ORDEN-SERVICE (dependiente)
      # ───────────────────────────────
      - name: Iniciar orden-service
        env:
          SPRING_DATASOURCE_USERNAME: ${{ secrets.DB_USERNAME }}
          SPRING_DATASOURCE_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          cd orden-service
          nohup java -jar target/*.jar \
            --server.port=8082 \
            --spring.datasource.url=jdbc:postgresql://localhost:5434/ordendb \
            --external.product-service.url=http://localhost:8081 \
            > ../logs/orden-service.log 2>&1 &

      - name: Esperar hasta que los servicios estén listos
        run: sleep 25

      - name: Ejecutar integration tests (multi-module)
        env:
          PRODUCT_SERVICE_URL: http://localhost:8081
          ORDERS_SERVICE_URL: http://localhost:8082
        run: mvn -B test -pl producto-service,orden-service
      # =====================================================
      # Build Docker images
      # =====================================================
      - name: Build Docker images
        run: |
          docker build -t producto-service-img producto-service
          docker build -t orden-service-img orden-service
      - name: Trivy Image Scan - Producto Service
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: 'producto-service-img'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true

      - name: Trivy Image Scan - Orden Service
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: image
          image-ref: 'orden-service-img'
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true
      - name: Falla si HIGH/CRITICAL se hallan vulnerabilidades
        run: |
          if grep -R "CRITICAL\|HIGH" trivy*; then
            echo "Vulnerabilities detected. Failing pipeline."
            exit 1
          fi || true
      - name: Trivy - IaC Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: '.'
          severity: 'HIGH,CRITICAL'
      - name: Download falcoctl
        run: |
          curl -sLO https://falcoctl.s3.amazonaws.com/latest/falcoctl-linux-amd64
          chmod +x falcoctl-linux-amd64
          mv falcoctl-linux-amd64 /usr/local/bin/falcoctl

      - name: Lint Falco rules via Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}/rules:/rules \
            falcosecurity/falco:latest \
            falco --rules /rules --dry-run
