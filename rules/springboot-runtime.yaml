# ==========================================
# Reglas Falco para Microservicios Spring Boot
# ==========================================

# ---------------
# Lista de procesos permitidos
# ---------------
springboot_allowed_processes:
  items:
    - java
    - java.exe
    - java.bin
    - /usr/bin/java
  description: Procesos permitidos dentro de nuestros contenedores Spring Boot
  condition: evt.arg.procname in (__springboot_allowed_processes)
  macro: __springboot_allowed_processes
  # Comentario: Define los procesos Java est√°ndar que se esperan en el contenedor

# --------------------------------------
# Regla 1: Detectar shell interactivo dentro del contenedor
# --------------------------------------
- rule: Shell Dentro del Contenedor
  desc: Detecta la ejecuci√≥n de sh/bash dentro de un contenedor Spring Boot
  condition: >
    container.id != host and
    proc.name in (bash, sh, ash, zsh) and
    evt.type = execve
  output: >
    üö® Shell detectada dentro del contenedor (proc=%proc.name user=%user.name container=%container.id image=%container.image)
  priority: CRITICAL
  tags: [contenedor, proceso, seguridad]
  # Comentario: Evita que alguien abra una shell interactiva en el contenedor

# --------------------------------------
# Regla 2: Ejecuci√≥n sospechosa de comandos
# --------------------------------------
- rule: Ejecuci√≥n de Procesos Sospechosos en Contenedor Spring Boot
  desc: Detecta la ejecuci√≥n de herramientas que normalmente no est√°n en un runtime Java
  condition: >
    container.id != host and
    evt.type = execve and
    proc.name in (curl, wget, nc, netcat, socat, tcpdump, nmap, bash, sh, ssh)
  output: >
    ‚ö† Proceso sospechoso ejecutado en contenedor (proc=%proc.name args=%proc.args container=%container.id image=%container.image)
  priority: HIGH
  tags: [contenedor, runtime, ataque]
  # Comentario: Detecta comandos de red o utilidades que podr√≠an usarse para ataques desde el contenedor

# --------------------------------------
# Regla 3: Modificaci√≥n de /etc dentro del contenedor
# --------------------------------------
- rule: Escritura en /etc desde el contenedor
  desc: Detecta intentos de escribir en /etc/* desde contenedores Spring Boot
  condition: >
    container.id != host and
    evt.type in (open,openat,creat) and
    fd.name startswith "/etc" and
    evt.arg.flags contains O_WRONLY
  output: >
    üö® Escritura en /etc dentro del contenedor (archivo=%fd.name user=%user.name proc=%proc.name container=%container.id)
  priority: CRITICAL
  tags: [sistema-de-archivos, contenedor, escalamiento-de-privilegios]
  # Comentario: Evita cambios cr√≠ticos en archivos de configuraci√≥n del sistema

# --------------------------------------
# Regla 4: Acceso al socket de Docker (posible escape)
# --------------------------------------
- rule: Acceso a Docker Socket Dentro del Contenedor
  desc: El acceso a docker.sock puede indicar un intento de escape del contenedor
  condition: >
    container.id != host and
    fd.name = "/var/run/docker.sock" and
    evt.type in (open,openat)
  output: >
    üö® Contenedor accediendo a docker.sock (proc=%proc.name user=%user.name container=%container.id)
  priority: CRITICAL
  tags: [escape, escalamiento-de-privilegios, contenedor]
  # Comentario: Detecta intentos de controlar Docker desde dentro del contenedor

# --------------------------------------
# Regla 5: Acceso a archivos sensibles
# --------------------------------------
- rule: Lectura de Archivos Sensibles
  desc: Detecta la lectura de secretos o claves privadas dentro del contenedor
  condition: >
    container.id != host and
    evt.type in (open,openat) and
    fd.name in ("/etc/shadow", "/etc/passwd", "/root/.ssh/id_rsa", "/run/secrets", "/var/run/secrets/kubernetes.io/serviceaccount/token")
  output: >
    ‚ö† Lectura de archivo sensible dentro del contenedor (archivo=%fd.name proc=%proc.name container=%container.id)
  priority: HIGH
  tags: [secretos, sistema-de-archivos, contenedor]
  # Comentario: Evita exposici√≥n de contrase√±as o tokens de Kubernetes

# --------------------------------------
# Regla 6: Procesos hijos inesperados desde Java/Spring Boot
# --------------------------------------
- rule: Java Generando Procesos Inesperados
  desc: Las aplicaciones Spring Boot normalmente no generan subprocesos del sistema operativo
  condition: >
    container.id != host and
    proc.pname in (__springboot_allowed_processes) and
    not proc.name in (java, java.bin, java.exe)
  output: >
    ‚ö† Sospechoso: Java gener√≥ un proceso hijo (padre=%proc.pname hijo=%proc.name args=%proc.args container=%container.id)
  priority: MEDIUM
  tags: [springboot, runtime, sospechoso]
  # Comentario: Detecta procesos adicionales que podr√≠an indicar un comportamiento malicioso
